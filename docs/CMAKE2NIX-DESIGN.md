# cmake2nix Design: Non-Flake Workflow

## Motivation

Inspired by `node2nix`, `cmake2nix` should work seamlessly without requiring a flake. This allows:
- Usage on non-flake systems
- Integration with traditional Nix workflows
- Simpler onboarding for users unfamiliar with flakes
- Direct import in nixpkgs-style overlays

## Workflow Comparison

### node2nix
```bash
# Input: package.json, package-lock.json
$ node2nix

# Output: three files
- node-packages.nix    # Package definitions
- node-env.nix         # Build environment logic
- default.nix          # Composition expression

# Usage
$ nix-build -A package
$ nix-env -f default.nix -iA package
```

### cmake2nix (proposed)
```bash
# Input: CMakeLists.txt (+ optional cmake-lock.json)
$ cmake2nix

# Output: four files
- cmake-packages.nix   # Package definitions
- cmake-env.nix        # Build environment logic (hooks, builders)
- default.nix          # Composition expression
- cmake-lock.json      # Lock file with hashes (updated if needed)

# Usage
$ nix-build -A package
$ nix-env -f default.nix -iA package
```

## File Structure

### cmake-lock.json
```json
{
  "version": "1.0",
  "dependencies": {
    "fmt": {
      "name": "fmt",
      "version": "10.2.1",
      "method": "fetchFromGitHub",
      "args": {
        "owner": "fmtlib",
        "repo": "fmt",
        "rev": "10.2.1",
        "hash": "sha256-pEltGLAHLZ3xypD/Ur4dWPWJ9BGVXwqQyKcDWVmC3co="
      },
      "metadata": {
        "gitRepository": "https://github.com/fmtlib/fmt.git",
        "gitTag": "10.2.1"
      }
    }
  }
}
```

### cmake-packages.nix
```nix
# Generated by cmake2nix
{ fetchFromGitHub
, fetchgit
, fetchurl
}:

{
  # Dependencies from cmake-lock.json
  fmt = {
    name = "fmt";
    version = "10.2.1";
    src = fetchFromGitHub {
      owner = "fmtlib";
      repo = "fmt";
      rev = "10.2.1";
      hash = "sha256-pEltGLAHLZ3xypD/Ur4dWPWJ9BGVXwqQyKcDWVmC3co=";
    };
  };

  # Add more dependencies...
}
```

### cmake-env.nix
```nix
# Generated by cmake2nix
# Build environment for nix-cmake projects
{ lib
, stdenv
, cmake
, ninja
, git
, makeBinaryWrapper
}:

let
  # Import the nix-cmake hooks and builders
  cmakeDependencyHook = (callPackage <path-to-hook> { }).setupHook;

  builders = import <path-to-builders> { inherit lib pkgs; };
in

{
  # Expose buildCMakePackage for use in default.nix
  inherit (builders) buildCMakePackage;

  # Helper to inject FetchContent deps from lock file
  mkFetchContentEnv = deps:
    lib.mapAttrs' (name: dep:
      lib.nameValuePair "FETCHCONTENT_SOURCE_DIR_${lib.toUpper name}" "${dep.src}"
    ) deps;
}
```

### default.nix
```nix
# Generated by cmake2nix
{ pkgs ? import <nixpkgs> { }
, system ? builtins.currentSystem
}:

let
  # Import dependencies
  cmakeDeps = pkgs.callPackage ./cmake-packages.nix { };

  # Import build environment
  cmakeEnv = pkgs.callPackage ./cmake-env.nix { };

in

{
  # The main package
  package = cmakeEnv.buildCMakePackage {
    pname = "my-project";
    version = "0.1.0";
    src = ./.;

    # Auto-inject dependencies from lock file
    fetchContentDeps = cmakeDeps;
  };

  # Individual dependencies (for overrides or direct access)
  inherit (cmakeDeps) fmt;

  # Shell for development
  shell = pkgs.mkShell {
    nativeBuildInputs = [
      pkgs.cmake
      pkgs.ninja
    ];

    shellHook = cmakeEnv.mkFetchContentEnv cmakeDeps;
  };
}
```

## Discovery Workflow

Unlike node2nix which reads package.json directly, cmake2nix needs to **run CMake** to discover dependencies:

```bash
# 1. Initial discovery (no lock file yet)
$ cmake2nix discover

# This:
# - Creates a FOD-based discovery derivation
# - Runs CMake with network access to find dependencies
# - Generates cmake-lock.json with placeholder hashes
# - Outputs: "⚠️  Lock file created with placeholder hashes. Run 'cmake2nix prefetch' to get real hashes."

# 2. Prefetch actual hashes
$ cmake2nix prefetch

# This:
# - Reads cmake-lock.json
# - Prefetches each dependency using nix-prefetch-url/nix-prefetch-git
# - Updates cmake-lock.json with real hashes
# - Outputs: "✓ Lock file updated with ${count} hashes"

# 3. Generate Nix expressions
$ cmake2nix generate

# This:
# - Reads cmake-lock.json
# - Generates cmake-packages.nix, cmake-env.nix, default.nix
# - Outputs: "✓ Generated cmake-packages.nix, cmake-env.nix, default.nix"

# 4. Or do all steps at once
$ cmake2nix

# Equivalent to: discover && prefetch && generate
```

## Command-Line Interface

```bash
cmake2nix [command] [options]

Commands:
  discover        Discover dependencies by running CMake (generates lock file)
  prefetch        Prefetch hashes for dependencies in lock file
  generate        Generate Nix expressions from lock file
  lock            Alias for: discover && prefetch
  init [dir]      Scaffold a new nix-cmake project
  shell           Enter development shell with dependencies
  build           Build the project
  help            Show this message

Options:
  -i, --input <file>         CMakeLists.txt location (default: ./CMakeLists.txt)
  -l, --lock-file <file>     Lock file location (default: ./cmake-lock.json)
  -o, --output <dir>         Output directory for generated files (default: .)
  --packages-nix <file>      Name of packages file (default: cmake-packages.nix)
  --env-nix <file>           Name of environment file (default: cmake-env.nix)
  --composition <file>       Name of composition file (default: default.nix)
  --cmake-flags <flags>      Additional CMake flags for discovery
  --no-prefetch              Skip hash prefetching (use placeholder hashes)
  --recursive                Enable recursive dependency discovery

Examples:
  # Standard workflow (discover + prefetch + generate)
  cmake2nix

  # Just update lock file
  cmake2nix lock

  # Generate from existing lock file
  cmake2nix generate

  # Custom output paths
  cmake2nix -i src/CMakeLists.txt -o nix/

  # With CMake flags
  cmake2nix --cmake-flags="-DBUILD_TESTS=OFF -DBUILD_EXAMPLES=OFF"
```

## Flake Support

The non-flake workflow doesn't preclude flake support. Users can use both:

**Traditional Nix:**
```bash
$ cmake2nix
$ nix-build -A package
```

**Flakes:**
```nix
{
  inputs.nix-cmake.url = "github:sielicki/nix-cmake";

  outputs = { nix-cmake, nixpkgs, ... }: {
    packages.x86_64-linux.default =
      (nix-cmake.lib.workspace nixpkgs.legacyPackages.x86_64-linux)
        .loadWorkspace { workspaceRoot = ./.; }
        .buildPackage {
          pname = "my-project";
          version = "0.1.0";
        };
  };
}
```

## Migration Path

For existing projects using flakes:
1. `cmake2nix` still works - it can detect and use an existing flake.nix
2. Generates standalone files that can be used without flakes
3. Allows gradual migration from flake → non-flake or vice versa

## Advantages

1. **No flake requirement** - Works with traditional Nix
2. **Explicit dependencies** - Lock file is human-readable and editable
3. **Reproducible** - Hashes ensure same dependencies across machines
4. **Overridable** - Generated expressions can be overridden like node2nix
5. **Familiar** - Similar to node2nix, poetry2nix, yarn2nix workflows

## Implementation Notes

### Hash Prefetching

Like node2nix, we use nix-prefetch-* tools to get real hashes:

```bash
# For GitHub dependencies
nix-prefetch-github <owner> <repo> --rev <rev>

# For Git dependencies
nix-prefetch-git <url> --rev <rev>

# For URLs
nix-prefetch-url <url>
```

### Discovery Phase

The discovery phase must:
1. Create a temporary build environment
2. Run CMake with network access (FOD)
3. Intercept FetchContent/CPM calls via dependency provider
4. Extract dependency metadata (URL, tag, version)
5. Generate initial lock file with placeholder hashes

### Lock File Updates

When CMakeLists.txt changes:
```bash
# Update lock file (add/remove dependencies)
$ cmake2nix lock

# This detects changes and:
# - Adds new dependencies
# - Removes unused dependencies
# - Preserves existing hashes
# - Prefetches hashes for new dependencies
```

## Future Enhancements

1. **Multiple lock files** - Support monorepos with per-package locks
2. **Lock file merging** - Merge multiple cmake-lock.json files
3. **Dependency overrides** - Override specific dependencies in lock file
4. **Version constraints** - Specify version ranges, not just exact versions
5. **Private repositories** - Support SSH-based Git fetching like node2nix
6. **Binary cache** - Share pre-built dependencies via cache

## Comparison to Other *2nix Tools

| Feature | node2nix | poetry2nix | cmake2nix (proposed) |
|---------|----------|------------|----------------------|
| No flake required | ✓ | ✓ | ✓ |
| Generates standalone .nix | ✓ | ✓ | ✓ |
| Lock file | package-lock.json | poetry.lock | cmake-lock.json |
| Hash prefetching | ✓ | ✓ | ✓ |
| Overridable | ✓ | ✓ | ✓ |
| Development shell | ✓ | ✓ | ✓ |

## References

- [node2nix README](https://github.com/svanderburg/node2nix)
- [poetry2nix](https://github.com/nix-community/poetry2nix)
- [crane (Rust)](https://github.com/ipetkov/crane)
