# nix-cmake API Reference

This document describes the current Nix API for `nix-cmake`.

## Workspace API (`lib.workspace`)

The workspace API handles project discovery, File API interrogation, and dependency logging.

### `discoverDependencies`
Performs a guest configuration of a CMake project to extract File API replies and Nix-CMake discovery logs.

**Arguments:**
- `src`: Path to source directory.
- `cmake` (optional): CMake package to use (defaults to in-tree `cmakeMinimal`).
- `cmakeFlags` (optional): List of CMake configuration flags.
- `cmakeToolchainFile` (optional): Path to toolchain file.
- `recursive` (optional): Whether to allow network access for recursive discovery.

### `recursiveDiscover`
A wrapper around `discoverDependencies` that sets `recursive = true` and requires an `outputHash` (Fixed-Output Derivation).

### `loadWorkspace`
The primary entry point for managing a project workspace.

**Arguments:**
- `src`: Path to source directory.
- `lockFile` (optional): Path to a JSON lock file.
- `fetchers` (optional): Attrset mapping dependency names to source derivations.

**Returns:**
- `src`: Original source.
- `lock`: Parsed lock file.
- `overlay`: A Nixpkgs overlay for the project's dependencies.

### `mkProjectOverlay`
Generates a Nixpkgs overlay from a lock file and a set of fetchers.

### `extractFromCodemodel`
Parses CMake File API (v2) replies from a configured workspace to extract target information.

### `extractFromDiscoveryLog`
Parses the `discovery-log.json` generated by the dependency provider to extract intercepted `FetchContent` calls.

---

## Builders API (`lib.builders`)

### `buildCMakePackage`
A high-level wrapper around `stdenv.mkDerivation` that automatically integrates Nix-CMake hooks.

**Key Arguments:**
- `cmake` (optional): CMake package to use (defaults to in-tree `cmakeMinimal`).
- `fetchContentDeps`: Attrset of dependency sources to be injected into the environment.
- `cmakeToolchainHook`: Optional toolchain hook derivation.
- `cmakeDependencyHook`: Optional dependency hook derivation.

### `applyLockFile`
Converts a parsed lock file and fetchers into environment variables suitable for `cmakeDependencyHook`.

---

## Hooks (`pkgs/`)

### `cmakeToolchainHook`
Provides a declarative `CMAKE_TOOLCHAIN_FILE` that handles Nix's cross-compilation and compiler wrappers.

### `cmakeDependencyHook`
A CMake dependency provider injected via `CMAKE_PROJECT_TOP_LEVEL_INCLUDES`. It intercepts `FetchContent` and `CPM` calls to provide Nix-managed sources.
